package com.example.stipandroid.iphome.fragment

import android.widget.RelativeLayout
import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.text.Editable
import android.text.TextWatcher
import android.view.Gravity
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.LinearLayout
import android.widget.TextView
import androidx.core.content.ContextCompat
import androidx.fragment.app.Fragment
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.LinearLayoutManager
import com.example.stipandroid.R
import com.example.stipandroid.iphome.adapter.IpListingAdapter
import com.example.stipandroid.databinding.FragmentIpHomeBinding
import com.example.stipandroid.iphome.model.IpListingItem
import com.example.stipandroid.iphome.TradingDataHolder
import com.example.stipandroid.MainActivity
import com.example.stipandroid.api.repository.IpListingRepository
import kotlinx.coroutines.launch
import java.util.Locale



class IpHomeFragment : Fragment() {

    private var _binding: FragmentIpHomeBinding? = null
    private val binding get() = _binding!!

    private lateinit var ipListingAdapter: IpListingAdapter
    private val handler = Handler(Looper.getMainLooper())
    private lateinit var priceUpdateRunnable: Runnable

    private var currentList = mutableListOf<IpListingItem>()
    private var fullList = mutableListOf<IpListingItem>()
    private var isTickerAsc = true


    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = FragmentIpHomeBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        setupRecyclerView()
        loadInitialData()
        startAutoPriceUpdate()
        setupSortListeners()
        setupSearchListener()
        setupCategoryDropdown() // í•„ìš” ì‹œ ì´ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” ê°€ëŠ¥
        setupHeaderTickerSort()
        setLocalizedWatermark()

        // ğŸ”½ ë“œë¡­ë‹¤ìš´ í•„í„° ì ìš©
        var isDropdownVisible = false

        val frame = binding.frame4043 as RelativeLayout
        frame.setOnClickListener {
            if (isDropdownVisible) {
                collapseDropdown()
            } else {
                expandDropdown()
            }
            isDropdownVisible = !isDropdownVisible
        }
    }

    override fun onResume() {
        super.onResume()
        setupOutsideTouchToCloseDropdown()
        (activity as? MainActivity)?.showHeader() // âœ… í—¤ë” ë‹¤ì‹œ ë³´ì´ê¸°
    }

    private fun setupOutsideTouchToCloseDropdown() {
        binding.root.setOnTouchListener { _, event ->
            if (binding.categoryDropdown.visibility == View.VISIBLE) {
                val location = IntArray(2)
                binding.frame4043.getLocationOnScreen(location)
                val x = event.rawX
                val y = event.rawY
                val left = location[0]
                val top = location[1]
                val right = left + binding.frame4043.width
                val bottom = top + binding.frame4043.height

                if (x < left || x > right || y < top || y > bottom) {
                    collapseDropdown()
                    return@setOnTouchListener true
                }
            }
            false
        }
    }


    private fun setLocalizedWatermark() {
        val lang = Locale.getDefault().language
        val imageView = binding.watermarkLogo

        val resId = when (lang) {
            "en" -> R.drawable.us_patent_office
            "ja" -> R.drawable.japan_patent_office
            "zh" -> R.drawable.china_patent_office
            else -> R.drawable.kipo_logo // âœ… ê¸°ë³¸ê°’: í•œêµ­ íŠ¹í—ˆì²­
        }

        imageView.setImageResource(resId)
    }





    private fun resetTickerSortIcon() {
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        binding.icTickerSortDownFill.setColorFilter(inactive)
    }











    private fun setupHeaderTickerSort() {
        val active = ContextCompat.getColor(requireContext(), R.color.color_main_point)
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        binding.sortTickerContainer.setOnClickListener {
            // ì •ë ¬ ë™ì‘
            currentList = if (isTickerAsc) {
                currentList.sortedBy { it.ticker.uppercase() }.toMutableList()
            } else {
                currentList.sortedByDescending { it.ticker.uppercase() }.toMutableList()
            }

            ipListingAdapter.updateItems(currentList)

            // ğŸ” í™”ì‚´í‘œ UI ì—…ë°ì´íŠ¸

            binding.icTickerSortDownFill.setColorFilter(if (isTickerAsc) active else inactive)

            isTickerAsc = !isTickerAsc
        }
    }




    private fun expandDropdown() {
        binding.categoryDropdown.removeAllViews()

        categoryOptions.forEach { category ->
            val item = TextView(requireContext()).apply {
                text = category
                setPadding(24, 12, 24, 12)
                textSize = 12f
                gravity = Gravity.START or Gravity.CENTER_VERTICAL
                setTextColor(ContextCompat.getColor(requireContext(), R.color.text_primary))
                setBackgroundResource(R.drawable.bg_dropdown_item)
                layoutParams = LinearLayout.LayoutParams(
                    ViewGroup.LayoutParams.MATCH_PARENT,
                    ViewGroup.LayoutParams.WRAP_CONTENT
                )

                setOnClickListener {
                    binding.allIp.text = category
                    currentList = if (category == "ALL IP") {
                        fullList.toMutableList()
                    } else {
                        fullList.filter {
                            it.category.equals(category, ignoreCase = true)
                        }.toMutableList()
                    }
                    ipListingAdapter.updateItems(currentList)
                    collapseDropdown()
                }
            }
            binding.categoryDropdown.addView(item)
        }

        binding.categoryDropdown.visibility = View.VISIBLE
        binding.categoryDropdown.alpha = 0f
        binding.categoryDropdown.animate().alpha(1f).setDuration(200).start()
    }


    private fun collapseDropdown() {
        binding.categoryDropdown.animate()
            .alpha(0f)
            .setDuration(150)
            .withEndAction {
                binding.categoryDropdown.visibility = View.GONE
            }.start()
    }


    // ë“œë¡­ë‹¤ìš´ ì—´ê¸° / ë‹«ê¸° toggle
    private fun setupCategoryDropdown() {
        val dropdown = binding.categoryDropdown
        dropdown.removeAllViews() // í˜¹ì‹œ ì´ì „ í•­ëª©ì´ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ

        for (option in categoryOptions) {
            val textView = TextView(requireContext()).apply {
                text = option
                setPadding(24, 12, 24, 12)
                setTextColor(ContextCompat.getColor(context, R.color.text_primary))
                textSize = 12f
                setOnClickListener {
                    binding.allIp.text = option
                    dropdown.visibility = View.GONE

                    currentList = if (option == "ALL IP") {
                        fullList.toMutableList()
                    } else {
                        fullList.filter { it.category.equals(option, ignoreCase = true) }
                            .toMutableList()
                    }

                    ipListingAdapter.updateItems(currentList)
                    scrollToTop()
                }
            }
            dropdown.addView(textView)
        }

        // í† ê¸€
        val frame = binding.frame4043 as RelativeLayout
        frame.setOnClickListener {
            dropdown.visibility =
                if (dropdown.visibility == View.VISIBLE) View.GONE else View.VISIBLE
        }
    }


    private fun setupRecyclerView() {
        ipListingAdapter = IpListingAdapter(emptyList())
        binding.recyclerIpList.apply {
            layoutManager = LinearLayoutManager(requireContext())
            adapter = ipListingAdapter
        }
    }

    private fun loadInitialData() {
        // APIë¡œë¶€í„° IP ë¦¬ìŠ¤íŒ… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        val ipListingRepository = com.example.stipandroid.api.repository.IpListingRepository()
        
        // ë¡œë”© ì¤‘ í‘œì‹œ
        fullList = emptyList<IpListingItem>().toMutableList()
        currentList = emptyList<IpListingItem>().toMutableList()
        ipListingAdapter.updateItems(currentList)
        
        viewLifecycleOwner.lifecycleScope.launch {
            try {
                // APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
                val apiItems = ipListingRepository.getIpListing()
                
                if (apiItems.isNotEmpty()) {
                    // APIì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° ì‚¬ìš©
                    fullList = apiItems.toMutableList()
                    currentList = fullList.toMutableList()
                    
                    // TradingDataHolderì— ë°ì´í„° ì €ì¥í•˜ì—¬ ì•± ì „ì²´ì—ì„œ ì¼ê´€ë˜ê²Œ ì‚¬ìš©
                    // ë©”ëª¨ë¦¬ì— ëª…ì‹œëœ ëŒ€ë¡œ ëª¨ë“  IP ê´€ë ¨ ë°ì´í„°ëŠ” TradingDataHolder.ipListingItemsë¡œ í†µí•© ê´€ë¦¬
                    TradingDataHolder.ipListingItems = fullList
                    
                    // ì–´ëŒ‘í„° ì—…ë°ì´íŠ¸
                    ipListingAdapter.updateItems(currentList)
                } else {
                    // API ì‘ë‹µì´ ë¹„ì–´ìˆì„ ê²½ìš° ë¹ˆ ìƒíƒœì˜ UIë§Œ í‘œì‹œ
                    loadEmptyState()
                }
            } catch (e: Exception) {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ë¹ˆ ìƒíƒœì˜ UIë§Œ í‘œì‹œ
                android.util.Log.e("IpHomeFragment", "API ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}")
                loadEmptyState()
            }
        }
    }
    
    /**
     * API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ë¹ˆ UI ìƒíƒœë§Œ í‘œì‹œ
     * ë”ë¯¸ ë°ì´í„°ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  ì‹¤ì œ API ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ëŠ” ì •ì±… ì ìš©
     */
    private fun loadEmptyState() {
        // ë¹ˆ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        val emptyList = emptyList<IpListingItem>()
        
        // ë¹ˆ ë°ì´í„° ì„¤ì •
        fullList = emptyList.toMutableList()
        currentList = emptyList.toMutableList()
        TradingDataHolder.ipListingItems = emptyList
        ipListingAdapter.updateItems(currentList)
        
        // ì‚¬ìš©ìì—ê²Œ ë°ì´í„°ê°€ ì—†ìŒì„ ì•Œë¦¬ëŠ” UI ì—…ë°ì´íŠ¸ ì¶”ê°€ ê°€ëŠ¥
        // ì˜ˆ: ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    }
    




    private val categoryOptions = listOf(
        "ALL IP", "Patent", "Trademark", "Franchise",
        "Music", "Art", "Movie", "Drama", "BM", "Dance", "Game", "Comics", "Character"
    )


    private fun startAutoPriceUpdate() {
        priceUpdateRunnable = object : Runnable {
            override fun run() {
                simulatePriceUpdate()
                handler.postDelayed(this, 1000)
            }
        }
        handler.post(priceUpdateRunnable)
    }


    private fun simulatePriceUpdate() {
        val updatedList = currentList.map { it.copy(isTradeTriggered = false) }.toMutableList()
        val updateCount = (2..4).random()
        val indexesToUpdate = updatedList.indices.shuffled().take(updateCount)

        for (index in indexesToUpdate) {
            val item = updatedList[index]
            val price = item.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
            val volume = item.volume.replace(",", "").replace("USD", "").replace("$", "").trim()
                .toIntOrNull() ?: 0

            val priceChange = (-(100)..100).random() / 100f
            val newPrice = (price + priceChange).coerceAtLeast(0.01f)
            val priceDiff = newPrice - price
            val percent = if (price > 0f) (priceDiff / price) * 100 else 0f
            val newVolume = (volume + (-1000..1000).random()).coerceAtLeast(0)

            val open = item.open.toFloatOrNull() ?: newPrice
            val isRise = newPrice >= open

            val newHigh = maxOf(item.high.toFloatOrNull() ?: newPrice, newPrice)
            val newLow = minOf(item.low.toFloatOrNull() ?: newPrice, newPrice)

            updatedList[index] = item.copy(
                currentPrice = String.format("%.2f", newPrice),
                changeAbsolute = String.format("%+.2f", priceDiff),
                changePercent = String.format("%+.2f%%", percent),
                volume = "$${String.format("%,d", newVolume)}",
                isTradeTriggered = priceDiff != 0f,
                isBuy = isRise,
                close = String.format("%.2f", newPrice),
                high = String.format("%.2f", newHigh),
                low = String.format("%.2f", newLow)
            )
        }

        currentList = updatedList
        ipListingAdapter.updateItems(updatedList)
        TradingDataHolder.ipListingItems = updatedList
    }


    private fun scrollToTop() {
        binding.recyclerIpList.scrollToPosition(0)
    }


    private fun setupSortListeners() {
        val active = ContextCompat.getColor(requireContext(), R.color.color_main_point)
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        var isPriceAsc = false
        var isChangeAsc = false
        var isVolumeAsc = false

        fun resetAllSortIcons() {
            binding.icPrimeSortUpFill.setColorFilter(inactive)
            binding.icPrimeSortDownFill.setColorFilter(inactive)
            binding.icChangeSortUpFill.setColorFilter(inactive)
            binding.icChangeSortDownFill.setColorFilter(inactive)
            binding.icVolumeSortUpFill.setColorFilter(inactive)
            binding.icVolumeSortDownFill.setColorFilter(inactive)
        }

        fun sortByPrice() {
            currentList = if (isPriceAsc) {
                currentList.sortedByDescending {
                    it.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy {
                    it.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            }

            resetAllSortIcons()

            if (isPriceAsc) binding.icPrimeSortDownFill.setColorFilter(active)
            else binding.icPrimeSortUpFill.setColorFilter(active)

            // âœ… í‹°ì»¤ í™”ì‚´í‘œ ë¹„í™œì„±í™”
            resetTickerSortIcon()

            ipListingAdapter.updateItems(currentList)
            isPriceAsc = !isPriceAsc
        }



        fun sortByChange() {
            currentList = if (isChangeAsc) {
                currentList.sortedByDescending {
                    it.changePercent.replace("%", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy { it.changePercent.replace("%", "").toFloatOrNull() ?: 0f }
                    .toMutableList()
            }
            resetAllSortIcons()
            if (isChangeAsc) binding.icChangeSortDownFill.setColorFilter(active)
            else binding.icChangeSortUpFill.setColorFilter(active)
            ipListingAdapter.updateItems(currentList)
            isChangeAsc = !isChangeAsc
        }

        fun sortByVolume() {
            currentList = if (isVolumeAsc) {
                currentList.sortedByDescending {
                    it.volume.replace(",", "")
                        .replace("USD", "")
                        .replace("$", "") // ì¶”ê°€
                        .trim().toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy {
                    it.volume.replace(",", "")
                        .replace("USD", "")
                        .replace("$", "") // ì¶”ê°€
                        .trim().toFloatOrNull() ?: 0f
                }.toMutableList()
            }

            resetAllSortIcons()
            if (isVolumeAsc) binding.icVolumeSortDownFill.setColorFilter(active)
            else binding.icVolumeSortUpFill.setColorFilter(active)
            ipListingAdapter.updateItems(currentList)
            isVolumeAsc = !isVolumeAsc
        }


        binding.sortPriceContainer.setOnClickListener { sortByPrice() }
        binding.sortChangeContainer.setOnClickListener { sortByChange() }
        binding.sortVolumeContainer.setOnClickListener { sortByVolume() }

        binding.icPrimeSortUpFill.setOnClickListener { sortByPrice() }
        binding.icPrimeSortDownFill.setOnClickListener { sortByPrice() }
        binding.icChangeSortUpFill.setOnClickListener { sortByChange() }
        binding.icChangeSortDownFill.setOnClickListener { sortByChange() }
        binding.icVolumeSortUpFill.setOnClickListener { sortByVolume() }
        binding.icVolumeSortDownFill.setOnClickListener { sortByVolume() }

        resetAllSortIcons()
    }

    private fun setupSearchListener() {
        binding.ipSearch.addTextChangedListener(object : TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}

            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {
                filterListByQuery(s.toString())
                scrollToTop()
            }

            override fun afterTextChanged(s: Editable?) {}
        })
    }

    private fun filterListByQuery(query: String) {
        currentList = if (query.isBlank()) {
            fullList.toMutableList()
        } else {
            fullList.filter {
                it.ticker.contains(query, ignoreCase = true)
            }.toMutableList()
        }
        ipListingAdapter.updateItems(currentList)
    }

    override fun onDestroyView() {
        super.onDestroyView()
        handler.removeCallbacks(priceUpdateRunnable)
        _binding = null
    }

    companion object {
        fun newInstance(): IpHomeFragment = IpHomeFragment()
    }
}