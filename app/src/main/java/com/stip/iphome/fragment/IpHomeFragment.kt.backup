package com.example.stipandroid.iphome.fragment

import android.widget.RelativeLayout
import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.text.Editable
import android.text.TextWatcher
import android.view.Gravity
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.LinearLayout
import android.widget.TextView
import androidx.core.content.ContextCompat
import androidx.fragment.app.Fragment
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.LinearLayoutManager
import com.example.stipandroid.R
import com.example.stipandroid.iphome.adapter.IpListingAdapter
import com.example.stipandroid.databinding.FragmentIpHomeBinding
import com.example.stipandroid.iphome.model.IpListingItem
import com.example.stipandroid.iphome.TradingDataHolder
import com.example.stipandroid.MainActivity
import com.example.stipandroid.api.repository.IpListingRepository
import kotlinx.coroutines.launch
import java.util.Locale



class IpHomeFragment : Fragment() {

    private var _binding: FragmentIpHomeBinding? = null
    private val binding get() = _binding!!

    private lateinit var ipListingAdapter: IpListingAdapter
    private val handler = Handler(Looper.getMainLooper())
    private lateinit var priceUpdateRunnable: Runnable

    private var currentList = mutableListOf<IpListingItem>()
    private var fullList = mutableListOf<IpListingItem>()
    private var isTickerAsc = true


    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = FragmentIpHomeBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        setupRecyclerView()
        loadInitialData()
        startAutoPriceUpdate()
        setupSortListeners()
        setupSearchListener()
        setupCategoryDropdown() // í•„ìš” ì‹œ ì´ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” ê°€ëŠ¥
        setupHeaderTickerSort()
        setLocalizedWatermark()

        // ğŸ”½ ë“œë¡­ë‹¤ìš´ í•„í„° ì ìš©
        var isDropdownVisible = false

        val frame = binding.frame4043 as RelativeLayout
        frame.setOnClickListener {
            if (isDropdownVisible) {
                collapseDropdown()
            } else {
                expandDropdown()
            }
            isDropdownVisible = !isDropdownVisible
        }
    }

    override fun onResume() {
        super.onResume()
        setupOutsideTouchToCloseDropdown()
        (activity as? MainActivity)?.showHeader() // âœ… í—¤ë” ë‹¤ì‹œ ë³´ì´ê¸°
    }

    private fun setupOutsideTouchToCloseDropdown() {
        binding.root.setOnTouchListener { _, event ->
            if (binding.categoryDropdown.visibility == View.VISIBLE) {
                val location = IntArray(2)
                binding.frame4043.getLocationOnScreen(location)
                val x = event.rawX
                val y = event.rawY
                val left = location[0]
                val top = location[1]
                val right = left + binding.frame4043.width
                val bottom = top + binding.frame4043.height

                if (x < left || x > right || y < top || y > bottom) {
                    collapseDropdown()
                    return@setOnTouchListener true
                }
            }
            false
        }
    }


    private fun setLocalizedWatermark() {
        val lang = Locale.getDefault().language
        val imageView = binding.watermarkLogo

        val resId = when (lang) {
            "en" -> R.drawable.us_patent_office
            "ja" -> R.drawable.japan_patent_office
            "zh" -> R.drawable.china_patent_office
            else -> R.drawable.kipo_logo // âœ… ê¸°ë³¸ê°’: í•œêµ­ íŠ¹í—ˆì²­
        }

        imageView.setImageResource(resId)
    }





    private fun resetTickerSortIcon() {
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        binding.icTickerSortDownFill.setColorFilter(inactive)
    }











    private fun setupHeaderTickerSort() {
        val active = ContextCompat.getColor(requireContext(), R.color.color_main_point)
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        binding.sortTickerContainer.setOnClickListener {
            // ì •ë ¬ ë™ì‘
            currentList = if (isTickerAsc) {
                currentList.sortedBy { it.ticker.uppercase() }.toMutableList()
            } else {
                currentList.sortedByDescending { it.ticker.uppercase() }.toMutableList()
            }

            ipListingAdapter.updateItems(currentList)

            // ğŸ” í™”ì‚´í‘œ UI ì—…ë°ì´íŠ¸

            binding.icTickerSortDownFill.setColorFilter(if (isTickerAsc) active else inactive)

            isTickerAsc = !isTickerAsc
        }
    }




    private fun expandDropdown() {
        binding.categoryDropdown.removeAllViews()

        categoryOptions.forEach { category ->
            val item = TextView(requireContext()).apply {
                text = category
                setPadding(24, 12, 24, 12)
                textSize = 12f
                gravity = Gravity.START or Gravity.CENTER_VERTICAL
                setTextColor(ContextCompat.getColor(requireContext(), R.color.text_primary))
                setBackgroundResource(R.drawable.bg_dropdown_item)
                layoutParams = LinearLayout.LayoutParams(
                    ViewGroup.LayoutParams.MATCH_PARENT,
                    ViewGroup.LayoutParams.WRAP_CONTENT
                )

                setOnClickListener {
                    binding.allIp.text = category
                    currentList = if (category == "ALL IP") {
                        fullList.toMutableList()
                    } else {
                        fullList.filter {
                            it.category.equals(category, ignoreCase = true)
                        }.toMutableList()
                    }
                    ipListingAdapter.updateItems(currentList)
                    collapseDropdown()
                }
            }
            binding.categoryDropdown.addView(item)
        }

        binding.categoryDropdown.visibility = View.VISIBLE
        binding.categoryDropdown.alpha = 0f
        binding.categoryDropdown.animate().alpha(1f).setDuration(200).start()
    }


    private fun collapseDropdown() {
        binding.categoryDropdown.animate()
            .alpha(0f)
            .setDuration(150)
            .withEndAction {
                binding.categoryDropdown.visibility = View.GONE
            }.start()
    }


    // ë“œë¡­ë‹¤ìš´ ì—´ê¸° / ë‹«ê¸° toggle
    private fun setupCategoryDropdown() {
        val dropdown = binding.categoryDropdown
        dropdown.removeAllViews() // í˜¹ì‹œ ì´ì „ í•­ëª©ì´ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ

        for (option in categoryOptions) {
            val textView = TextView(requireContext()).apply {
                text = option
                setPadding(24, 12, 24, 12)
                setTextColor(ContextCompat.getColor(context, R.color.text_primary))
                textSize = 12f
                setOnClickListener {
                    binding.allIp.text = option
                    dropdown.visibility = View.GONE

                    currentList = if (option == "ALL IP") {
                        fullList.toMutableList()
                    } else {
                        fullList.filter { it.category.equals(option, ignoreCase = true) }
                            .toMutableList()
                    }

                    ipListingAdapter.updateItems(currentList)
                    scrollToTop()
                }
            }
            dropdown.addView(textView)
        }

        // í† ê¸€
        val frame = binding.frame4043 as RelativeLayout
        frame.setOnClickListener {
            dropdown.visibility =
                if (dropdown.visibility == View.VISIBLE) View.GONE else View.VISIBLE
        }
    }


    private fun setupRecyclerView() {
        ipListingAdapter = IpListingAdapter(emptyList())
        binding.recyclerIpList.apply {
            layoutManager = LinearLayoutManager(requireContext())
            adapter = ipListingAdapter
        }
    }

    private fun loadInitialData() {
        // APIë¡œë¶€í„° IP ë¦¬ìŠ¤íŒ… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        val ipListingRepository = com.example.stipandroid.api.repository.IpListingRepository()
        
        // ë¡œë”© ì¤‘ í‘œì‹œ
        fullList = emptyList<IpListingItem>().toMutableList()
        currentList = emptyList<IpListingItem>().toMutableList()
        ipListingAdapter.updateItems(currentList)
        
        viewLifecycleOwner.lifecycleScope.launch {
            try {
                // APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
                val apiItems = ipListingRepository.getIpListing()
                
                if (apiItems.isNotEmpty()) {
                    // APIì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° ì‚¬ìš©
                    fullList = apiItems.toMutableList()
                    currentList = fullList.toMutableList()
                    
                    // TradingDataHolderì— ë°ì´í„° ì €ì¥í•˜ì—¬ ì•± ì „ì²´ì—ì„œ ì¼ê´€ë˜ê²Œ ì‚¬ìš©
                    // ë©”ëª¨ë¦¬ì— ëª…ì‹œëœ ëŒ€ë¡œ ëª¨ë“  IP ê´€ë ¨ ë°ì´í„°ëŠ” TradingDataHolder.ipListingItemsë¡œ í†µí•© ê´€ë¦¬
                    TradingDataHolder.ipListingItems = fullList
                    
                    // ì–´ëŒ‘í„° ì—…ë°ì´íŠ¸
                    ipListingAdapter.updateItems(currentList)
                } else {
                    // API ì‘ë‹µì´ ë¹„ì–´ìˆì„ ê²½ìš° ë¹ˆ ìƒíƒœì˜ UIë§Œ í‘œì‹œ
                    loadEmptyState()
                }
            } catch (e: Exception) {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ë¹ˆ ìƒíƒœì˜ UIë§Œ í‘œì‹œ
                android.util.Log.e("IpHomeFragment", "API ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}")
                loadEmptyState()
            }
        }
    }
    
    /**
     * API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ë¹ˆ UI ìƒíƒœë§Œ í‘œì‹œ
     * ë”ë¯¸ ë°ì´í„°ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  ì‹¤ì œ API ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ëŠ” ì •ì±… ì ìš©
     */
    private fun loadEmptyState() {
        // ë¹ˆ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        val emptyList = emptyList<IpListingItem>()
        
        // ë¹ˆ ë°ì´í„° ì„¤ì •
        fullList = emptyList.toMutableList()
        currentList = emptyList.toMutableList()
        TradingDataHolder.ipListingItems = emptyList
        ipListingAdapter.updateItems(currentList)
        
        // ì‚¬ìš©ìì—ê²Œ ë°ì´í„°ê°€ ì—†ìŒì„ ì•Œë¦¬ëŠ” UI ì—…ë°ì´íŠ¸ ì¶”ê°€ ê°€ëŠ¥
        // ì˜ˆ: ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    }
    
    // ë”ë¯¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜ ì œê±° - ì‹¤ì œ API ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ëŠ” ì •ì±… ì ìš©
                low = "0.00",
                close = "0.00",
                type = "",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "",
                totalIssuanceLimit = "",
                registrationNumber = "",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "JWV",
                currentPrice = "0.00",
                changePercent = "0.00%",
                changeAbsolute = "0.00",
                volume = "0",
                companyName = "ì¤€ì›ì§€ë¹„ì•„ì´",
                high24h = "0.00",
                low24h = "0.00",
                open = "0.00",
                high = "0.00",
                low = "0.00",
                close = "0.00",
                type = "",
                category = "Patent",
                low24h = "4.50",
                open = "4.60",
                high = "4.90",
                low = "4.50",
                close = "4.71",
                type = "ë§¤ìˆ˜",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "DRA-ETIP-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "633,300",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "THEB",
                currentPrice = "11.22",
                changePercent = "+2.00%",
                changeAbsolute = "+0.22",
                volume = "$9,500",
                companyName = "THE ë¹µ",
                high24h = "11.80",
                low24h = "10.90",
                open = "11.00",
                high = "11.70",
                low = "10.90",
                close = "11.22",
                type = "ë§¤ìˆ˜",
                category = "Franchise",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "FRC-THEB-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "899,999",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "TMNT",
                currentPrice = "3.30",
                changePercent = "-53.52%",
                changeAbsolute = "-3.80",
                volume = "$21,000",
                companyName = "í„°ë¯¸ë„¤ì´í„°",
                high24h = "7.80",
                low24h = "6.90",
                open = "7.10",
                high = "7.60",
                low = "6.90",
                close = "3.30",
                type = "ë§¤ë„",
                category = "Movie",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MOV-TMNT-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "199,999",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "CDM",
                currentPrice = "7.12",
                changePercent = "+1.71%",
                changeAbsolute = "+0.12",
                volume = "$14,000",
                companyName = "í•œêµ­ìƒì§ë³¸ë¶€",
                high24h = "7.50",
                low24h = "6.80",
                open = "7.00",
                high = "7.45",
                low = "6.80",
                close = "7.12",
                type = "ë§¤ìˆ˜",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-CDM-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "123,349",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "IJECT",
                currentPrice = "2.12",
                changePercent = "+0.95%",
                changeAbsolute = "+0.02",
                volume = "$18,000",
                companyName = "ë©”ë””í—ˆë¸Œ",
                high24h = "2.30",
                low24h = "2.00",
                open = "2.10",
                high = "2.25",
                low = "2.00",
                close = "2.12",
                type = "ë§¤ìˆ˜",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-IJECT-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "710,200",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),


            IpListingItem(
                logoResId = null,
                ticker = "ETIP AI",
                currentPrice = "1.23",
                changePercent = "-75.88%",
                changeAbsolute = "-3.87",
                volume = "$11,200",
                companyName = "ETIP AI",
                high24h = "5.50",
                low24h = "5.00",
                open = "5.10",
                high = "5.45",
                low = "5.00",
                close = "1.23",
                type = "ë§¤ë„",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "KR-ETAI-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "330,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP MF",
                currentPrice = "2.95",
                changePercent = "-38.54%",
                changeAbsolute = "-1.85",
                volume = "$9,800",
                companyName = "ETIP ì œì¡°ì—…",
                high24h = "5.20",
                low24h = "4.70",
                open = "4.80",
                high = "5.10",
                low = "4.70",
                close = "2.95",
                type = "ë§¤ë„",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "KR-ETMF-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "220,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP SMC",
                currentPrice = "8.40",
                changePercent = "+3.70%",
                changeAbsolute = "+0.30",
                volume = "$15,000",
                companyName = "ETIP ë°˜ë„ì²´",
                high24h = "8.90",
                low24h = "8.00",
                open = "8.10",
                high = "8.80",
                low = "8.00",
                close = "8.40",
                type = "ë§¤ìˆ˜",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "US-SMC-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "520,120",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP EC",
                currentPrice = "10.21",
                changePercent = "+2.61%",
                changeAbsolute = "+0.26",
                volume = "$20,000",
                companyName = "ETIP ì „ê¸°ì°¨",
                high24h = "10.80",
                low24h = "9.90",
                open = "9.95",
                high = "10.60",
                low = "9.90",
                close = "10.21",
                type = "ë§¤ìˆ˜",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "USD-EC-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "440,441",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP RE",
                currentPrice = "7.55",
                changePercent = "+4.14%",
                changeAbsolute = "+0.30",
                volume = "$13,500",
                companyName = "ETIP ì‹ ì¬ìƒ",
                high24h = "8.00",
                low24h = "7.20",
                open = "7.25",
                high = "7.85",
                low = "7.20",
                close = "7.55",
                type = "ë§¤ìˆ˜",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CHN-ETIP-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "123,456",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),


            IpListingItem(
                logoResId = null,
                ticker = "PORO",
                currentPrice = "1.95",
                changePercent = "-47.58%",
                changeAbsolute = "-1.77",
                volume = "$6,300",
                companyName = "ë½€ë¡œë¡œ í¬ë¡±",
                high24h = "4.10",
                low24h = "3.70",
                open = "3.72",
                high = "4.00",
                low = "3.70",
                close = "1.95",
                type = "ë§¤ë„",
                category = "Character",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CHR-POR-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "333,333",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP ë¡œë´‡",
                currentPrice = "3.00",
                changePercent = "-48.28%",
                changeAbsolute = "-2.80",
                volume = "$8,100",
                companyName = "ETIP ë¡œë´‡",
                high24h = "6.40",
                low24h = "5.70",
                open = "5.80",
                high = "6.35",
                low = "5.70",
                close = "3.00",
                type = "ë§¤ë„",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-RBT-202505",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "890,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "NIKE",
                currentPrice = "5.31",
                changePercent = "-41.00%",
                changeAbsolute = "-3.69",
                volume = "$19,400",
                companyName = "ë‚˜ì´í‚¤ ìƒí‘œ",
                high24h = "9.90",
                low24h = "8.90",
                open = "9.00",
                high = "9.85",
                low = "8.90",
                close = "5.31",
                type = "ë§¤ë„",
                category = "Trademark",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "TRM-NKE-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "110,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP í—¬ìŠ¤",
                currentPrice = "4.33",
                changePercent = "+5.61%",
                changeAbsolute = "+0.23",
                volume = "$7,900",
                companyName = "ETIP í—¬ìŠ¤ì¼€ì–´",
                high24h = "4.60",
                low24h = "4.00",
                open = "4.10",
                high = "4.50",
                low = "4.00",
                close = "4.33",
                type = "ë§¤ìˆ˜",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-HC-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "444,400",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "GGDM",
                currentPrice = "11.90",
                changePercent = "+3.93%",
                changeAbsolute = "+0.45",
                volume = "$22,000",
                companyName = "ê´‘í™”ë¬¸ GD",
                high24h = "12.50",
                low24h = "11.40",
                open = "11.45",
                high = "12.30",
                low = "11.40",
                close = "11.90",
                type = "ë§¤ìˆ˜",
                category = "Music",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MUS-GGD-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "222,200",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),


            IpListingItem(
                logoResId = null,
                ticker = "PPONG",
                currentPrice = "2.45",
                changePercent = "-52.88%",
                changeAbsolute = "-2.75",
                volume = "$10,600",
                companyName = "í•œêµ­ì˜í™” ë½•",
                high24h = "5.80",
                low24h = "5.10",
                open = "5.20",
                high = "5.75",
                low = "5.10",
                close = "2.45",
                type = "ë§¤ë„",
                category = "Movie",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MOV-PPO-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "350,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "TSBC",
                currentPrice = "1.87",
                changePercent = "-48.77%",
                changeAbsolute = "-1.78",
                volume = "$5,800",
                companyName = "íˆ¬ì¸ë²…ìŠ¤ ì»¤í”¼",
                high24h = "4.00",
                low24h = "3.60",
                open = "3.65",
                high = "3.98",
                low = "3.60",
                close = "1.87",
                type = "ë§¤ë„",
                category = "Franchise",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "FRC-TSB-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "999,999",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "CASINO ",
                currentPrice = "6.71",
                changePercent = "+3.23%",
                changeAbsolute = "+0.21",
                volume = "$9,900",
                companyName = "ì¹´ì§€ë…¸",
                high24h = "7.00",
                low24h = "6.40",
                open = "6.50",
                high = "6.95",
                low = "6.40",
                close = "6.71",
                type = "ë§¤ìˆ˜",
                category = "Drama",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "DRA-CAN-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "555,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "BMMK",
                currentPrice = "7.88",
                changePercent = "+3.68%",
                changeAbsolute = "+0.28",
                volume = "$12,400",
                companyName = "ê²€ì€ì‹ í™” ì˜¤ê³µ",
                high24h = "8.30",
                low24h = "7.50",
                open = "7.60",
                high = "8.20",
                low = "7.50",
                close = "7.88",
                type = "ë§¤ìˆ˜",
                category = "Game",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "GAM-BMK-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "666,600",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "IDOL",
                currentPrice = "6.22",
                changePercent = "-30.89%",
                changeAbsolute = "-2.78",
                volume = "$14,600",
                companyName = "ì•„ì´ëŒ ëŒ„ìŠ¤",
                high24h = "9.80",
                low24h = "8.90",
                open = "9.00",
                high = "9.70",
                low = "8.90",
                close = "6.22",
                type = "ë§¤ë„",
                category = "Dance",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "DAN-IDL-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "777,700",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),


            IpListingItem(
                logoResId = null,
                ticker = "LJART",
                currentPrice = "6.44",
                changePercent = "-35.87%",
                changeAbsolute = "-3.61",
                volume = "$17,800",
                companyName = "í™”ê°€ì„ì§„",
                high24h = "11.00",
                low24h = "10.00",
                open = "10.05",
                high = "10.95",
                low = "10.00",
                close = "6.44",
                type = "ë§¤ë„",
                category = "Art",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "ART-LJR-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "888,800",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "CRTR",
                currentPrice = "4.67",
                changePercent = "-15.09%",
                changeAbsolute = "-0.83",
                volume = "$8,700",
                companyName = "í•´ì™¸ ìºë¦­í„°",
                high24h = "6.00",
                low24h = "5.40",
                open = "5.50",
                high = "5.95",
                low = "5.40",
                close = "4.67",
                type = "ë§¤ë„",
                category = "Character",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CHR-CRT-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "100,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "CHRY",
                currentPrice = "2.89",
                changePercent = "-56.21%",
                changeAbsolute = "-3.71",
                volume = "$11,000",
                companyName = "ì‰¬ë¦¬",
                high24h = "7.20",
                low24h = "6.50",
                open = "6.60",
                high = "7.10",
                low = "6.50",
                close = "2.89",
                type = "ë§¤ë„",
                category = "Movie",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MOV-CHR-202507",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "202,202",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "MOC",
                currentPrice = "8.01",
                changePercent = "+4.03%",
                changeAbsolute = "+0.31",
                volume = "$13,300",
                companyName = "ëª¨ë‘ì˜ ì¹˜í‚¨",
                high24h = "8.50",
                low24h = "7.60",
                open = "7.70",
                high = "8.40",
                low = "7.60",
                close = "8.01",
                type = "ë§¤ìˆ˜",
                category = "Franchise",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "FRC-MOC-202505",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "101,378",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "ONB",
                currentPrice = "1.55",
                changePercent = "-83.15%",
                changeAbsolute = "-7.65",
                volume = "$15,500",
                companyName = "ì›ë‚˜ë¸”",
                high24h = "10.00",
                low24h = "9.10",
                open = "9.20",
                high = "18.90",
                low = "1.10",
                close = "1.55",
                type = "ë§¤ë„",
                category = "Comics",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CTN-ONB-202507",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "765,982",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            )


        )

        val initial = rawList
            .filter { it.ticker != "USD" } // USD í‹°ì»¤ ì œì™¸
            .map {
                it.copy(
                    type = if ((0..1).random() == 0) "ë§¤ìˆ˜" else "ë§¤ë„",
                    isBuy = (0..1).random() == 0
                )
            }

        fullList = initial.toMutableList()
        currentList = initial.toMutableList()
        ipListingAdapter.updateItems(currentList)

        TradingDataHolder.ipListingItems = fullList
    }


    private val categoryOptions = listOf(
        "ALL IP", "Patent", "Trademark", "Franchise",
        "Music", "Art", "Movie", "Drama", "BM", "Dance", "Game", "Comics", "Character"
    )


    private fun startAutoPriceUpdate() {
        priceUpdateRunnable = object : Runnable {
            override fun run() {
                simulatePriceUpdate()
                handler.postDelayed(this, 1000)
            }
        }
        handler.post(priceUpdateRunnable)
    }


    private fun simulatePriceUpdate() {
        val updatedList = currentList.map { it.copy(isTradeTriggered = false) }.toMutableList()
        val updateCount = (2..4).random()
        val indexesToUpdate = updatedList.indices.shuffled().take(updateCount)

        for (index in indexesToUpdate) {
            val item = updatedList[index]
            val price = item.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
            val volume = item.volume.replace(",", "").replace("USD", "").replace("$", "").trim()
                .toIntOrNull() ?: 0

            val priceChange = (-(100)..100).random() / 100f
            val newPrice = (price + priceChange).coerceAtLeast(0.01f)
            val priceDiff = newPrice - price
            val percent = if (price > 0f) (priceDiff / price) * 100 else 0f
            val newVolume = (volume + (-1000..1000).random()).coerceAtLeast(0)

            val open = item.open.toFloatOrNull() ?: newPrice
            val isRise = newPrice >= open

            val newHigh = maxOf(item.high.toFloatOrNull() ?: newPrice, newPrice)
            val newLow = minOf(item.low.toFloatOrNull() ?: newPrice, newPrice)

            updatedList[index] = item.copy(
                currentPrice = String.format("%.2f", newPrice),
                changeAbsolute = String.format("%+.2f", priceDiff),
                changePercent = String.format("%+.2f%%", percent),
                volume = "$${String.format("%,d", newVolume)}",
                isTradeTriggered = priceDiff != 0f,
                isBuy = isRise,
                close = String.format("%.2f", newPrice),
                high = String.format("%.2f", newHigh),
                low = String.format("%.2f", newLow)
            )
        }

        currentList = updatedList
        ipListingAdapter.updateItems(updatedList)
        TradingDataHolder.ipListingItems = updatedList
    }


    private fun scrollToTop() {
        binding.recyclerIpList.scrollToPosition(0)
    }


    private fun setupSortListeners() {
        val active = ContextCompat.getColor(requireContext(), R.color.color_main_point)
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        var isPriceAsc = false
        var isChangeAsc = false
        var isVolumeAsc = false

        fun resetAllSortIcons() {
            binding.icPrimeSortUpFill.setColorFilter(inactive)
            binding.icPrimeSortDownFill.setColorFilter(inactive)
            binding.icChangeSortUpFill.setColorFilter(inactive)
            binding.icChangeSortDownFill.setColorFilter(inactive)
            binding.icVolumeSortUpFill.setColorFilter(inactive)
            binding.icVolumeSortDownFill.setColorFilter(inactive)
        }

        fun sortByPrice() {
            currentList = if (isPriceAsc) {
                currentList.sortedByDescending {
                    it.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy {
                    it.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            }

            resetAllSortIcons()

            if (isPriceAsc) binding.icPrimeSortDownFill.setColorFilter(active)
            else binding.icPrimeSortUpFill.setColorFilter(active)

            // âœ… í‹°ì»¤ í™”ì‚´í‘œ ë¹„í™œì„±í™”
            resetTickerSortIcon()

            ipListingAdapter.updateItems(currentList)
            isPriceAsc = !isPriceAsc
        }



        fun sortByChange() {
            currentList = if (isChangeAsc) {
                currentList.sortedByDescending {
                    it.changePercent.replace("%", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy { it.changePercent.replace("%", "").toFloatOrNull() ?: 0f }
                    .toMutableList()
            }
            resetAllSortIcons()
            if (isChangeAsc) binding.icChangeSortDownFill.setColorFilter(active)
            else binding.icChangeSortUpFill.setColorFilter(active)
            ipListingAdapter.updateItems(currentList)
            isChangeAsc = !isChangeAsc
        }

        fun sortByVolume() {
            currentList = if (isVolumeAsc) {
                currentList.sortedByDescending {
                    it.volume.replace(",", "")
                        .replace("USD", "")
                        .replace("$", "") // ì¶”ê°€
                        .trim().toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy {
                    it.volume.replace(",", "")
                        .replace("USD", "")
                        .replace("$", "") // ì¶”ê°€
                        .trim().toFloatOrNull() ?: 0f
                }.toMutableList()
            }

            resetAllSortIcons()
            if (isVolumeAsc) binding.icVolumeSortDownFill.setColorFilter(active)
            else binding.icVolumeSortUpFill.setColorFilter(active)
            ipListingAdapter.updateItems(currentList)
            isVolumeAsc = !isVolumeAsc
        }


        binding.sortPriceContainer.setOnClickListener { sortByPrice() }
        binding.sortChangeContainer.setOnClickListener { sortByChange() }
        binding.sortVolumeContainer.setOnClickListener { sortByVolume() }

        binding.icPrimeSortUpFill.setOnClickListener { sortByPrice() }
        binding.icPrimeSortDownFill.setOnClickListener { sortByPrice() }
        binding.icChangeSortUpFill.setOnClickListener { sortByChange() }
        binding.icChangeSortDownFill.setOnClickListener { sortByChange() }
        binding.icVolumeSortUpFill.setOnClickListener { sortByVolume() }
        binding.icVolumeSortDownFill.setOnClickListener { sortByVolume() }

        resetAllSortIcons()
    }

    private fun setupSearchListener() {
        binding.ipSearch.addTextChangedListener(object : TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}

            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {
                filterListByQuery(s.toString())
                scrollToTop()
            }

            override fun afterTextChanged(s: Editable?) {}
        })
    }

    private fun filterListByQuery(query: String) {
        currentList = if (query.isBlank()) {
            fullList.toMutableList()
        } else {
            fullList.filter {
                it.ticker.contains(query, ignoreCase = true)
            }.toMutableList()
        }
        ipListingAdapter.updateItems(currentList)
    }

    override fun onDestroyView() {
        super.onDestroyView()
        handler.removeCallbacks(priceUpdateRunnable)
        _binding = null
    }

    companion object {
        fun newInstance(): IpHomeFragment = IpHomeFragment()
    }
}