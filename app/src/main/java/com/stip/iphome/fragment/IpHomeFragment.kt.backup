package com.example.stipandroid.iphome.fragment

import android.widget.RelativeLayout
import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.text.Editable
import android.text.TextWatcher
import android.view.Gravity
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.LinearLayout
import android.widget.TextView
import androidx.core.content.ContextCompat
import androidx.fragment.app.Fragment
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.LinearLayoutManager
import com.example.stipandroid.R
import com.example.stipandroid.iphome.adapter.IpListingAdapter
import com.example.stipandroid.databinding.FragmentIpHomeBinding
import com.example.stipandroid.iphome.model.IpListingItem
import com.example.stipandroid.iphome.TradingDataHolder
import com.example.stipandroid.MainActivity
import com.example.stipandroid.api.repository.IpListingRepository
import kotlinx.coroutines.launch
import java.util.Locale



class IpHomeFragment : Fragment() {

    private var _binding: FragmentIpHomeBinding? = null
    private val binding get() = _binding!!

    private lateinit var ipListingAdapter: IpListingAdapter
    private val handler = Handler(Looper.getMainLooper())
    private lateinit var priceUpdateRunnable: Runnable

    private var currentList = mutableListOf<IpListingItem>()
    private var fullList = mutableListOf<IpListingItem>()
    private var isTickerAsc = true


    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = FragmentIpHomeBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        setupRecyclerView()
        loadInitialData()
        startAutoPriceUpdate()
        setupSortListeners()
        setupSearchListener()
        setupCategoryDropdown() // 필요 시 이 함수 내부에서 드롭다운 초기화 가능
        setupHeaderTickerSort()
        setLocalizedWatermark()

        // 🔽 드롭다운 필터 적용
        var isDropdownVisible = false

        val frame = binding.frame4043 as RelativeLayout
        frame.setOnClickListener {
            if (isDropdownVisible) {
                collapseDropdown()
            } else {
                expandDropdown()
            }
            isDropdownVisible = !isDropdownVisible
        }
    }

    override fun onResume() {
        super.onResume()
        setupOutsideTouchToCloseDropdown()
        (activity as? MainActivity)?.showHeader() // ✅ 헤더 다시 보이기
    }

    private fun setupOutsideTouchToCloseDropdown() {
        binding.root.setOnTouchListener { _, event ->
            if (binding.categoryDropdown.visibility == View.VISIBLE) {
                val location = IntArray(2)
                binding.frame4043.getLocationOnScreen(location)
                val x = event.rawX
                val y = event.rawY
                val left = location[0]
                val top = location[1]
                val right = left + binding.frame4043.width
                val bottom = top + binding.frame4043.height

                if (x < left || x > right || y < top || y > bottom) {
                    collapseDropdown()
                    return@setOnTouchListener true
                }
            }
            false
        }
    }


    private fun setLocalizedWatermark() {
        val lang = Locale.getDefault().language
        val imageView = binding.watermarkLogo

        val resId = when (lang) {
            "en" -> R.drawable.us_patent_office
            "ja" -> R.drawable.japan_patent_office
            "zh" -> R.drawable.china_patent_office
            else -> R.drawable.kipo_logo // ✅ 기본값: 한국 특허청
        }

        imageView.setImageResource(resId)
    }





    private fun resetTickerSortIcon() {
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        binding.icTickerSortDownFill.setColorFilter(inactive)
    }











    private fun setupHeaderTickerSort() {
        val active = ContextCompat.getColor(requireContext(), R.color.color_main_point)
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        binding.sortTickerContainer.setOnClickListener {
            // 정렬 동작
            currentList = if (isTickerAsc) {
                currentList.sortedBy { it.ticker.uppercase() }.toMutableList()
            } else {
                currentList.sortedByDescending { it.ticker.uppercase() }.toMutableList()
            }

            ipListingAdapter.updateItems(currentList)

            // 🔁 화살표 UI 업데이트

            binding.icTickerSortDownFill.setColorFilter(if (isTickerAsc) active else inactive)

            isTickerAsc = !isTickerAsc
        }
    }




    private fun expandDropdown() {
        binding.categoryDropdown.removeAllViews()

        categoryOptions.forEach { category ->
            val item = TextView(requireContext()).apply {
                text = category
                setPadding(24, 12, 24, 12)
                textSize = 12f
                gravity = Gravity.START or Gravity.CENTER_VERTICAL
                setTextColor(ContextCompat.getColor(requireContext(), R.color.text_primary))
                setBackgroundResource(R.drawable.bg_dropdown_item)
                layoutParams = LinearLayout.LayoutParams(
                    ViewGroup.LayoutParams.MATCH_PARENT,
                    ViewGroup.LayoutParams.WRAP_CONTENT
                )

                setOnClickListener {
                    binding.allIp.text = category
                    currentList = if (category == "ALL IP") {
                        fullList.toMutableList()
                    } else {
                        fullList.filter {
                            it.category.equals(category, ignoreCase = true)
                        }.toMutableList()
                    }
                    ipListingAdapter.updateItems(currentList)
                    collapseDropdown()
                }
            }
            binding.categoryDropdown.addView(item)
        }

        binding.categoryDropdown.visibility = View.VISIBLE
        binding.categoryDropdown.alpha = 0f
        binding.categoryDropdown.animate().alpha(1f).setDuration(200).start()
    }


    private fun collapseDropdown() {
        binding.categoryDropdown.animate()
            .alpha(0f)
            .setDuration(150)
            .withEndAction {
                binding.categoryDropdown.visibility = View.GONE
            }.start()
    }


    // 드롭다운 열기 / 닫기 toggle
    private fun setupCategoryDropdown() {
        val dropdown = binding.categoryDropdown
        dropdown.removeAllViews() // 혹시 이전 항목이 남아있을 수 있음

        for (option in categoryOptions) {
            val textView = TextView(requireContext()).apply {
                text = option
                setPadding(24, 12, 24, 12)
                setTextColor(ContextCompat.getColor(context, R.color.text_primary))
                textSize = 12f
                setOnClickListener {
                    binding.allIp.text = option
                    dropdown.visibility = View.GONE

                    currentList = if (option == "ALL IP") {
                        fullList.toMutableList()
                    } else {
                        fullList.filter { it.category.equals(option, ignoreCase = true) }
                            .toMutableList()
                    }

                    ipListingAdapter.updateItems(currentList)
                    scrollToTop()
                }
            }
            dropdown.addView(textView)
        }

        // 토글
        val frame = binding.frame4043 as RelativeLayout
        frame.setOnClickListener {
            dropdown.visibility =
                if (dropdown.visibility == View.VISIBLE) View.GONE else View.VISIBLE
        }
    }


    private fun setupRecyclerView() {
        ipListingAdapter = IpListingAdapter(emptyList())
        binding.recyclerIpList.apply {
            layoutManager = LinearLayoutManager(requireContext())
            adapter = ipListingAdapter
        }
    }

    private fun loadInitialData() {
        // API로부터 IP 리스팅 데이터 가져오기
        val ipListingRepository = com.example.stipandroid.api.repository.IpListingRepository()
        
        // 로딩 중 표시
        fullList = emptyList<IpListingItem>().toMutableList()
        currentList = emptyList<IpListingItem>().toMutableList()
        ipListingAdapter.updateItems(currentList)
        
        viewLifecycleOwner.lifecycleScope.launch {
            try {
                // API에서 데이터 가져오기 시도
                val apiItems = ipListingRepository.getIpListing()
                
                if (apiItems.isNotEmpty()) {
                    // API에서 가져온 데이터 사용
                    fullList = apiItems.toMutableList()
                    currentList = fullList.toMutableList()
                    
                    // TradingDataHolder에 데이터 저장하여 앱 전체에서 일관되게 사용
                    // 메모리에 명시된 대로 모든 IP 관련 데이터는 TradingDataHolder.ipListingItems로 통합 관리
                    TradingDataHolder.ipListingItems = fullList
                    
                    // 어댑터 업데이트
                    ipListingAdapter.updateItems(currentList)
                } else {
                    // API 응답이 비어있을 경우 빈 상태의 UI만 표시
                    loadEmptyState()
                }
            } catch (e: Exception) {
                // API 호출 실패 시 빈 상태의 UI만 표시
                android.util.Log.e("IpHomeFragment", "API 데이터 로드 실패: ${e.message}")
                loadEmptyState()
            }
        }
    }
    
    /**
     * API 호출 실패 시 빈 UI 상태만 표시
     * 더미 데이터는 사용하지 않고 실제 API 데이터만 사용하는 정책 적용
     */
    private fun loadEmptyState() {
        // 빈 리스트 생성
        val emptyList = emptyList<IpListingItem>()
        
        // 빈 데이터 설정
        fullList = emptyList.toMutableList()
        currentList = emptyList.toMutableList()
        TradingDataHolder.ipListingItems = emptyList
        ipListingAdapter.updateItems(currentList)
        
        // 사용자에게 데이터가 없음을 알리는 UI 업데이트 추가 가능
        // 예: 빈 상태 메시지 표시
    }
    
    // 더미 데이터 생성 함수 제거 - 실제 API 데이터만 사용하는 정책 적용
                low = "0.00",
                close = "0.00",
                type = "",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "",
                totalIssuanceLimit = "",
                registrationNumber = "",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "JWV",
                currentPrice = "0.00",
                changePercent = "0.00%",
                changeAbsolute = "0.00",
                volume = "0",
                companyName = "준원지비아이",
                high24h = "0.00",
                low24h = "0.00",
                open = "0.00",
                high = "0.00",
                low = "0.00",
                close = "0.00",
                type = "",
                category = "Patent",
                low24h = "4.50",
                open = "4.60",
                high = "4.90",
                low = "4.50",
                close = "4.71",
                type = "매수",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "DRA-ETIP-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "633,300",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "THEB",
                currentPrice = "11.22",
                changePercent = "+2.00%",
                changeAbsolute = "+0.22",
                volume = "$9,500",
                companyName = "THE 빵",
                high24h = "11.80",
                low24h = "10.90",
                open = "11.00",
                high = "11.70",
                low = "10.90",
                close = "11.22",
                type = "매수",
                category = "Franchise",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "FRC-THEB-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "899,999",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "TMNT",
                currentPrice = "3.30",
                changePercent = "-53.52%",
                changeAbsolute = "-3.80",
                volume = "$21,000",
                companyName = "터미네이터",
                high24h = "7.80",
                low24h = "6.90",
                open = "7.10",
                high = "7.60",
                low = "6.90",
                close = "3.30",
                type = "매도",
                category = "Movie",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MOV-TMNT-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "199,999",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "CDM",
                currentPrice = "7.12",
                changePercent = "+1.71%",
                changeAbsolute = "+0.12",
                volume = "$14,000",
                companyName = "한국생직본부",
                high24h = "7.50",
                low24h = "6.80",
                open = "7.00",
                high = "7.45",
                low = "6.80",
                close = "7.12",
                type = "매수",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-CDM-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "123,349",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "IJECT",
                currentPrice = "2.12",
                changePercent = "+0.95%",
                changeAbsolute = "+0.02",
                volume = "$18,000",
                companyName = "메디허브",
                high24h = "2.30",
                low24h = "2.00",
                open = "2.10",
                high = "2.25",
                low = "2.00",
                close = "2.12",
                type = "매수",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-IJECT-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "710,200",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),


            IpListingItem(
                logoResId = null,
                ticker = "ETIP AI",
                currentPrice = "1.23",
                changePercent = "-75.88%",
                changeAbsolute = "-3.87",
                volume = "$11,200",
                companyName = "ETIP AI",
                high24h = "5.50",
                low24h = "5.00",
                open = "5.10",
                high = "5.45",
                low = "5.00",
                close = "1.23",
                type = "매도",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "KR-ETAI-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "330,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP MF",
                currentPrice = "2.95",
                changePercent = "-38.54%",
                changeAbsolute = "-1.85",
                volume = "$9,800",
                companyName = "ETIP 제조업",
                high24h = "5.20",
                low24h = "4.70",
                open = "4.80",
                high = "5.10",
                low = "4.70",
                close = "2.95",
                type = "매도",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "KR-ETMF-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "220,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP SMC",
                currentPrice = "8.40",
                changePercent = "+3.70%",
                changeAbsolute = "+0.30",
                volume = "$15,000",
                companyName = "ETIP 반도체",
                high24h = "8.90",
                low24h = "8.00",
                open = "8.10",
                high = "8.80",
                low = "8.00",
                close = "8.40",
                type = "매수",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "US-SMC-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "520,120",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP EC",
                currentPrice = "10.21",
                changePercent = "+2.61%",
                changeAbsolute = "+0.26",
                volume = "$20,000",
                companyName = "ETIP 전기차",
                high24h = "10.80",
                low24h = "9.90",
                open = "9.95",
                high = "10.60",
                low = "9.90",
                close = "10.21",
                type = "매수",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "USD-EC-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "440,441",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP RE",
                currentPrice = "7.55",
                changePercent = "+4.14%",
                changeAbsolute = "+0.30",
                volume = "$13,500",
                companyName = "ETIP 신재생",
                high24h = "8.00",
                low24h = "7.20",
                open = "7.25",
                high = "7.85",
                low = "7.20",
                close = "7.55",
                type = "매수",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CHN-ETIP-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "123,456",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),


            IpListingItem(
                logoResId = null,
                ticker = "PORO",
                currentPrice = "1.95",
                changePercent = "-47.58%",
                changeAbsolute = "-1.77",
                volume = "$6,300",
                companyName = "뽀로로 크롱",
                high24h = "4.10",
                low24h = "3.70",
                open = "3.72",
                high = "4.00",
                low = "3.70",
                close = "1.95",
                type = "매도",
                category = "Character",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CHR-POR-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "333,333",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null


            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP 로봇",
                currentPrice = "3.00",
                changePercent = "-48.28%",
                changeAbsolute = "-2.80",
                volume = "$8,100",
                companyName = "ETIP 로봇",
                high24h = "6.40",
                low24h = "5.70",
                open = "5.80",
                high = "6.35",
                low = "5.70",
                close = "3.00",
                type = "매도",
                category = "Patent",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-RBT-202505",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "890,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "NIKE",
                currentPrice = "5.31",
                changePercent = "-41.00%",
                changeAbsolute = "-3.69",
                volume = "$19,400",
                companyName = "나이키 상표",
                high24h = "9.90",
                low24h = "8.90",
                open = "9.00",
                high = "9.85",
                low = "8.90",
                close = "5.31",
                type = "매도",
                category = "Trademark",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "TRM-NKE-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "110,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "ETIP 헬스",
                currentPrice = "4.33",
                changePercent = "+5.61%",
                changeAbsolute = "+0.23",
                volume = "$7,900",
                companyName = "ETIP 헬스케어",
                high24h = "4.60",
                low24h = "4.00",
                open = "4.10",
                high = "4.50",
                low = "4.00",
                close = "4.33",
                type = "매수",
                category = "Patent",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "PT-HC-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "444,400",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "GGDM",
                currentPrice = "11.90",
                changePercent = "+3.93%",
                changeAbsolute = "+0.45",
                volume = "$22,000",
                companyName = "광화문 GD",
                high24h = "12.50",
                low24h = "11.40",
                open = "11.45",
                high = "12.30",
                low = "11.40",
                close = "11.90",
                type = "매수",
                category = "Music",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MUS-GGD-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "222,200",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),


            IpListingItem(
                logoResId = null,
                ticker = "PPONG",
                currentPrice = "2.45",
                changePercent = "-52.88%",
                changeAbsolute = "-2.75",
                volume = "$10,600",
                companyName = "한국영화 뽕",
                high24h = "5.80",
                low24h = "5.10",
                open = "5.20",
                high = "5.75",
                low = "5.10",
                close = "2.45",
                type = "매도",
                category = "Movie",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MOV-PPO-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "350,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "TSBC",
                currentPrice = "1.87",
                changePercent = "-48.77%",
                changeAbsolute = "-1.78",
                volume = "$5,800",
                companyName = "투썸벅스 커피",
                high24h = "4.00",
                low24h = "3.60",
                open = "3.65",
                high = "3.98",
                low = "3.60",
                close = "1.87",
                type = "매도",
                category = "Franchise",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "FRC-TSB-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "999,999",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "CASINO ",
                currentPrice = "6.71",
                changePercent = "+3.23%",
                changeAbsolute = "+0.21",
                volume = "$9,900",
                companyName = "카지노",
                high24h = "7.00",
                low24h = "6.40",
                open = "6.50",
                high = "6.95",
                low = "6.40",
                close = "6.71",
                type = "매수",
                category = "Drama",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "DRA-CAN-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "555,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),
            IpListingItem(
                logoResId = null,
                ticker = "BMMK",
                currentPrice = "7.88",
                changePercent = "+3.68%",
                changeAbsolute = "+0.28",
                volume = "$12,400",
                companyName = "검은신화 오공",
                high24h = "8.30",
                low24h = "7.50",
                open = "7.60",
                high = "8.20",
                low = "7.50",
                close = "7.88",
                type = "매수",
                category = "Game",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "GAM-BMK-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "666,600",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "IDOL",
                currentPrice = "6.22",
                changePercent = "-30.89%",
                changeAbsolute = "-2.78",
                volume = "$14,600",
                companyName = "아이돌 댄스",
                high24h = "9.80",
                low24h = "8.90",
                open = "9.00",
                high = "9.70",
                low = "8.90",
                close = "6.22",
                type = "매도",
                category = "Dance",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "DAN-IDL-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "777,700",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            ),


            IpListingItem(
                logoResId = null,
                ticker = "LJART",
                currentPrice = "6.44",
                changePercent = "-35.87%",
                changeAbsolute = "-3.61",
                volume = "$17,800",
                companyName = "화가임진",
                high24h = "11.00",
                low24h = "10.00",
                open = "10.05",
                high = "10.95",
                low = "10.00",
                close = "6.44",
                type = "매도",
                category = "Art",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "ART-LJR-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "888,800",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "CRTR",
                currentPrice = "4.67",
                changePercent = "-15.09%",
                changeAbsolute = "-0.83",
                volume = "$8,700",
                companyName = "해외 캐릭터",
                high24h = "6.00",
                low24h = "5.40",
                open = "5.50",
                high = "5.95",
                low = "5.40",
                close = "4.67",
                type = "매도",
                category = "Character",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CHR-CRT-202504",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "100,000",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "CHRY",
                currentPrice = "2.89",
                changePercent = "-56.21%",
                changeAbsolute = "-3.71",
                volume = "$11,000",
                companyName = "쉬리",
                high24h = "7.20",
                low24h = "6.50",
                open = "6.60",
                high = "7.10",
                low = "6.50",
                close = "2.89",
                type = "매도",
                category = "Movie",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "MOV-CHR-202507",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "202,202",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "MOC",
                currentPrice = "8.01",
                changePercent = "+4.03%",
                changeAbsolute = "+0.31",
                volume = "$13,300",
                companyName = "모두의 치킨",
                high24h = "8.50",
                low24h = "7.60",
                open = "7.70",
                high = "8.40",
                low = "7.60",
                close = "8.01",
                type = "매수",
                category = "Franchise",
                isBuy = true,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "FRC-MOC-202505",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "101,378",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null
            ),
            IpListingItem(
                logoResId = null,
                ticker = "ONB",
                currentPrice = "1.55",
                changePercent = "-83.15%",
                changeAbsolute = "-7.65",
                volume = "$15,500",
                companyName = "원나블",
                high24h = "10.00",
                low24h = "9.10",
                open = "9.20",
                high = "18.90",
                low = "1.10",
                close = "1.55",
                type = "매도",
                category = "Comics",
                isBuy = false,
                firstIssuanceDate = "2025-06-01",
                totalIssuanceLimit = "1,000,000",
                registrationNumber = "CTN-ONB-202507",
                linkBlock = null,
                linkRating = null,
                linkLicense = null,
                linkVideo = null,
                currentCirculation = "765,982",
                linkDigitalIpPlan = null,
                linkLicenseAgreement = null,
                homepageLink = null,
                digitalIpLink = null,
                businessPlanLink = null,
                relatedVideoLink = null

            )


        )

        val initial = rawList
            .filter { it.ticker != "USD" } // USD 티커 제외
            .map {
                it.copy(
                    type = if ((0..1).random() == 0) "매수" else "매도",
                    isBuy = (0..1).random() == 0
                )
            }

        fullList = initial.toMutableList()
        currentList = initial.toMutableList()
        ipListingAdapter.updateItems(currentList)

        TradingDataHolder.ipListingItems = fullList
    }


    private val categoryOptions = listOf(
        "ALL IP", "Patent", "Trademark", "Franchise",
        "Music", "Art", "Movie", "Drama", "BM", "Dance", "Game", "Comics", "Character"
    )


    private fun startAutoPriceUpdate() {
        priceUpdateRunnable = object : Runnable {
            override fun run() {
                simulatePriceUpdate()
                handler.postDelayed(this, 1000)
            }
        }
        handler.post(priceUpdateRunnable)
    }


    private fun simulatePriceUpdate() {
        val updatedList = currentList.map { it.copy(isTradeTriggered = false) }.toMutableList()
        val updateCount = (2..4).random()
        val indexesToUpdate = updatedList.indices.shuffled().take(updateCount)

        for (index in indexesToUpdate) {
            val item = updatedList[index]
            val price = item.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
            val volume = item.volume.replace(",", "").replace("USD", "").replace("$", "").trim()
                .toIntOrNull() ?: 0

            val priceChange = (-(100)..100).random() / 100f
            val newPrice = (price + priceChange).coerceAtLeast(0.01f)
            val priceDiff = newPrice - price
            val percent = if (price > 0f) (priceDiff / price) * 100 else 0f
            val newVolume = (volume + (-1000..1000).random()).coerceAtLeast(0)

            val open = item.open.toFloatOrNull() ?: newPrice
            val isRise = newPrice >= open

            val newHigh = maxOf(item.high.toFloatOrNull() ?: newPrice, newPrice)
            val newLow = minOf(item.low.toFloatOrNull() ?: newPrice, newPrice)

            updatedList[index] = item.copy(
                currentPrice = String.format("%.2f", newPrice),
                changeAbsolute = String.format("%+.2f", priceDiff),
                changePercent = String.format("%+.2f%%", percent),
                volume = "$${String.format("%,d", newVolume)}",
                isTradeTriggered = priceDiff != 0f,
                isBuy = isRise,
                close = String.format("%.2f", newPrice),
                high = String.format("%.2f", newHigh),
                low = String.format("%.2f", newLow)
            )
        }

        currentList = updatedList
        ipListingAdapter.updateItems(updatedList)
        TradingDataHolder.ipListingItems = updatedList
    }


    private fun scrollToTop() {
        binding.recyclerIpList.scrollToPosition(0)
    }


    private fun setupSortListeners() {
        val active = ContextCompat.getColor(requireContext(), R.color.color_main_point)
        val inactive = ContextCompat.getColor(requireContext(), R.color.sort_inactive)

        var isPriceAsc = false
        var isChangeAsc = false
        var isVolumeAsc = false

        fun resetAllSortIcons() {
            binding.icPrimeSortUpFill.setColorFilter(inactive)
            binding.icPrimeSortDownFill.setColorFilter(inactive)
            binding.icChangeSortUpFill.setColorFilter(inactive)
            binding.icChangeSortDownFill.setColorFilter(inactive)
            binding.icVolumeSortUpFill.setColorFilter(inactive)
            binding.icVolumeSortDownFill.setColorFilter(inactive)
        }

        fun sortByPrice() {
            currentList = if (isPriceAsc) {
                currentList.sortedByDescending {
                    it.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy {
                    it.currentPrice.replace(",", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            }

            resetAllSortIcons()

            if (isPriceAsc) binding.icPrimeSortDownFill.setColorFilter(active)
            else binding.icPrimeSortUpFill.setColorFilter(active)

            // ✅ 티커 화살표 비활성화
            resetTickerSortIcon()

            ipListingAdapter.updateItems(currentList)
            isPriceAsc = !isPriceAsc
        }



        fun sortByChange() {
            currentList = if (isChangeAsc) {
                currentList.sortedByDescending {
                    it.changePercent.replace("%", "").toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy { it.changePercent.replace("%", "").toFloatOrNull() ?: 0f }
                    .toMutableList()
            }
            resetAllSortIcons()
            if (isChangeAsc) binding.icChangeSortDownFill.setColorFilter(active)
            else binding.icChangeSortUpFill.setColorFilter(active)
            ipListingAdapter.updateItems(currentList)
            isChangeAsc = !isChangeAsc
        }

        fun sortByVolume() {
            currentList = if (isVolumeAsc) {
                currentList.sortedByDescending {
                    it.volume.replace(",", "")
                        .replace("USD", "")
                        .replace("$", "") // 추가
                        .trim().toFloatOrNull() ?: 0f
                }.toMutableList()
            } else {
                currentList.sortedBy {
                    it.volume.replace(",", "")
                        .replace("USD", "")
                        .replace("$", "") // 추가
                        .trim().toFloatOrNull() ?: 0f
                }.toMutableList()
            }

            resetAllSortIcons()
            if (isVolumeAsc) binding.icVolumeSortDownFill.setColorFilter(active)
            else binding.icVolumeSortUpFill.setColorFilter(active)
            ipListingAdapter.updateItems(currentList)
            isVolumeAsc = !isVolumeAsc
        }


        binding.sortPriceContainer.setOnClickListener { sortByPrice() }
        binding.sortChangeContainer.setOnClickListener { sortByChange() }
        binding.sortVolumeContainer.setOnClickListener { sortByVolume() }

        binding.icPrimeSortUpFill.setOnClickListener { sortByPrice() }
        binding.icPrimeSortDownFill.setOnClickListener { sortByPrice() }
        binding.icChangeSortUpFill.setOnClickListener { sortByChange() }
        binding.icChangeSortDownFill.setOnClickListener { sortByChange() }
        binding.icVolumeSortUpFill.setOnClickListener { sortByVolume() }
        binding.icVolumeSortDownFill.setOnClickListener { sortByVolume() }

        resetAllSortIcons()
    }

    private fun setupSearchListener() {
        binding.ipSearch.addTextChangedListener(object : TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}

            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {
                filterListByQuery(s.toString())
                scrollToTop()
            }

            override fun afterTextChanged(s: Editable?) {}
        })
    }

    private fun filterListByQuery(query: String) {
        currentList = if (query.isBlank()) {
            fullList.toMutableList()
        } else {
            fullList.filter {
                it.ticker.contains(query, ignoreCase = true)
            }.toMutableList()
        }
        ipListingAdapter.updateItems(currentList)
    }

    override fun onDestroyView() {
        super.onDestroyView()
        handler.removeCallbacks(priceUpdateRunnable)
        _binding = null
    }

    companion object {
        fun newInstance(): IpHomeFragment = IpHomeFragment()
    }
}